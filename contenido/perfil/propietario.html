<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil propietario de finca</title>

  <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
  <link rel="stylesheet" href="../../style.css">
  <script src="../../app.js" defer></script>
  <script src="../../api.js" defer></script>
</head>

<body>
  <header class="header">
    <span>AgroSolidario</span>
    <nav>
      <a href="./propietario.html">Mi finca</a>
      <a href="../ofertas/index.html">Mis ofertas</a>
      <a href="../busqueda/index.html">Búsqueda de trabajadores</a>
      <a href="../../index.html" onclick="AuthService.logout()">Cerrar sesión</a>
    </nav>
  </header>

  <main class="container perfil perfil-propietario">
    <div class="perfil-top">
      <h2 class="perfil-top__title">Perfil:</h2>
      <a href="../busqueda/index.html" class="perfil-top__arrow" aria-label="Volver">→</a>
    </div>

    <section class="form-box perfil-card">
      <p class="perfil-card__section-title">Datos personales:</p>

      <div class="perfil-grid">
        <div class="full">
          <label for="nombre">Nombre completo:</label>
          <input id="nombre" class="readonly" type="text" disabled>
        </div>

        <div>
          <label for="doc">Número de documento:</label>
          <input id="doc" class="readonly" type="text" disabled>
        </div>

        <div>
          <label for="ubicacion">Ubicación:</label>
          <input id="ubicacion" type="text">
        </div>

        <div>
          <label for="celular">Número de celular:</label>
          <input id="celular" type="tel">
        </div>

        <div>
          <label for="correo">Correo:</label>
          <input id="correo" class="readonly" type="email" disabled>
        </div>
      </div>

      <p class="perfil-estado-doc">Documento de identidad - Guardado</p>
    </section>

    <div class="perfil-top perfil-top--finca">
      <h2 class="perfil-top__title">Mi finca:</h2>
    </div>

    <section class="form-box perfil-card">
      <p class="perfil-card__section-title">Información de la finca:</p>

      <div class="perfil-grid finca-grid">
        <div>
          <label for="nombre-finca">Nombre de la finca:</label>
          <input id="nombre-finca" type="text">
        </div>

        <div>
          <label for="ubicacion-finca">Ubicación:</label>
          <input id="ubicacion-finca" type="text">
        </div>

        <div>
          <label for="tamano">Tamaño o extensión (hectáreas):</label>
          <input id="tamano" type="text">
        </div>

        <div>
          <label for="tipo-prod">Tipo de producción:</label>
          <input id="tipo-prod" type="text">
        </div>

        <div class="full">
          <label for="desc-finca">Descripción de la finca:</label>
          <textarea id="desc-finca"></textarea>
        </div>
      </div>

      <p class="perfil-estado-doc">Documento de la finca - Guardado</p>
    </section>

    <section class="perfil-bottom">
      <div class="form-box perfil-card perfil-upload">
        <div class="perfil-upload__row">
          <p>Adjunte una foto de perfil:</p>
          <label class="upload-btn" for="foto">Subir archivo</label>
          <input id="foto" class="file-input" type="file" accept="image/*">
        </div>
      </div>

      <div class="form-box perfil-card perfil-note">
        <p class="perfil-note__title">Tener presente:</p>
        <p>
          Los datos como el nombre, el número de documento y el correo, no podrán ser cambiados
          a menos de que el usuario pida este al correo servicioalcliente@agrosolidario.com
        </p>
      </div>

      <div class="perfil-actions">
        <a href="../ofertas/index.html" class="btn-dark perfil-actions__btn">Cancelar</a>
        <button type="button" class="btn-dark perfil-actions__btn" id="btnGuardarPerfil">Guardar cambios</button>
      </div>
    </section>
  </main>

  <script>
    async function loadProfile() {
      const userStr = localStorage.getItem('user');
      const profileStr = localStorage.getItem('profile');
      
      if (!userStr) {
        window.location.href = '../../index.html';
        return;
      }
      
      const user = JSON.parse(userStr);
      let profile = profileStr ? JSON.parse(profileStr) : {};

      try {
        const data = await ProfileService.getProfile();
        if (data && data.profile) {
          profile = data.profile;
        }
      } catch (error) {
        console.error('Error fetching profile:', error);
      }

      document.getElementById('nombre').value = user.nombre || '';
      document.getElementById('doc').value = profile.numeroDocumento || '';
      document.getElementById('ubicacion').value = profile.ubicacion || '';
      document.getElementById('celular').value = profile.numeroCelular || '';
      document.getElementById('correo').value = user.email || '';
      document.getElementById('nombre-finca').value = profile.nombreFinca || '';
      document.getElementById('ubicacion-finca').value = profile.ubicacionFinca || '';
      document.getElementById('tamano').value = profile.tamano || '';
      document.getElementById('tipo-prod').value = profile.tipo_prod || '';
      document.getElementById('desc-finca').value = profile.desc_finca || '';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadProfile();

      document.getElementById('btnGuardarPerfil').addEventListener('click', async (e) => {
        e.preventDefault();
        
        try {
          const profileData = {
            numeroDocumento: document.getElementById('doc').value,
            ubicacion: document.getElementById('ubicacion').value,
            numeroCelular: document.getElementById('celular').value,
            nombreFinca: document.getElementById('nombre-finca').value,
            ubicacionFinca: document.getElementById('ubicacion-finca').value,
            tamano: document.getElementById('tamano').value,
            tipo_prod: document.getElementById('tipo-prod').value,
            desc_finca: document.getElementById('desc-finca').value,
          };

          console.log('Saving profile:', profileData);
          const result = await ProfileService.updateProfile(profileData);
          console.log('Save result:', result);
          window.location.href = './info-guardada.html';
        } catch (error) {
          console.error('Save error:', error);
          alert('Error al guardar: ' + error.message);
        }
      });
    });
  </script>
</body>

</html>
